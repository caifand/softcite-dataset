---
title: "TEI Corpus Summary"
author: "Fan Du"
date: "5/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(xml2)
library(ggplot2)
library(janitor)
library(kableExtra)
library(wesanderson)

tei_doc <- read_xml("https://raw.githubusercontent.com/ourresearch/software-mentions/master/resources/dataset/software/corpus/all_clean_post_processed_with_no_mention.tei.xml") %>% xml_ns_strip()
```

As of May 30, 2020, the softcite TEI corpus contains: 

* 4,976 articles, 2,318 paragraphs, and 1,079 non-matched quotes
* 3,544 articles with zero mentions, and 1,432 articles with software mentions
  * Among 1,432 articles with mentions, 1,245 have annotated paragraphs matched with PDF; 484 articles have non-matched quotes.
  * All the 1,245 articles are reviewed by curators during the consistency improvement.
* 2,521 PMC articles and 2,450 econ articles
* 5,210 software entities and 3,188 software attributes annotated. 8,398 annotations in total.
* 1,217 annotations manually edited during the consistency check


```{r, eval=F}
# xml_find_num(tei_doc, xpath="count(//fileDesc[@xml:id])")
# 4,976 articles in tei_doc
# xml_find_num(tei_doc, xpath="count(//TEI[@subtype='pmc'])")
# 2,521 PMC articles in tei_doc
# xml_find_num(tei_doc, xpath="count(//TEI[@subtype='econ'])")
# 2,450 econ articles in tei_doc
# missing 5 articles with correct subtype

# xml_find_num(tei_doc, xpath="count(//p)")
# 2,318 paragraphs in tei_doc
# xml_find_num(tei_doc, xpath="count(//ab)")
# 1,079 non-matched quotes in tei_doc
# xml_find_num(tei_doc, xpath="count(//body[not(node())])")
# 3,544 articles with zero mentions
# xml_find_num(tei_doc, xpath="count(//body[.//text()])")
# 1,432 articles with mentions
# xml_find_num(tei_doc, xpath="count(//body[./p/text()])")
# 1,245 articles with annotated paragraphs
# xml_find_num(tei_doc, xpath="count(//body[./ab/text()])")
# 484 articles with non-matched annotated quotes
# xml_find_num(tei_doc, xpath="count(//body[./ab/text() and ./p/text()])")
# 297 articles with both annotated paragraphs and non-matched quotes

# xml_find_num(tei_doc, xpath="count(//rs[@type='software'])")
# 5,210 annotations of software entity
# xml_find_num(tei_doc, xpath="count(//rs)")
# 8,398 annotations in total
# which means 3,188 annotations of software attributes

# xml_find_num(tei_doc, xpath="count(//rs[@type='software' and @resp='#curator'])")
# 773 annotations of software entity edited by curator
# xml_find_num(tei_doc, xpath="count(//rs[@resp='#curator'])")
# 1,217 annotations edited by curator in total

```

```{r, include=F}
# library(VennDiagram)
# draw.pairwise.venn(1245,484,297,category=c("articles with matched mentions", "articles with non-matched mentions"), lty = rep("blank", 2), fill = c("light blue", "pink"), alpha = rep(0.5, 2), cat.pos = c(0,0), cat.dist = rep(0.025, 2), scaled = FALSE)
```


```{r, include==F}
# xml_find_num(tei_doc, xpath="count(//textClass)")
# 4,974 articles have </textClass> -> TODO: still 2 missing

# xml_find_all(tei_doc, xpath="//TEI[not(.//profileDesc)]")
# a2008-39-NAT_BIOTECHNOL
# a2007-48-UNDERSEA_HYPERBAR_M

# xml_find_num(tei_doc, xpath="count(//textClass/catRef[@target='#unique_annotator'])")
# 4,402 single annotated articles
# xml_find_num(tei_doc, xpath="count(//textClass/catRef[@target='#multiple_annotator'])")
# 572 multiple annotated articles
# xml_find_num(tei_doc, xpath="count(//textClass/catRef[@target='#with_reconciliation'])")
# so actually no one in this class
# xml_find_num(tei_doc, xpath="count(//textClass/catRef[@target='#with_reconciliation_and_scripts'])")
# 1,245 articles with reconciliation and scripts (all the articles with software mentions)

articles <- xml_find_all(tei_doc, xpath="//fileDesc[@xml:id]") %>% xml_attrs %>% unlist()

unique_annotator <- xml_find_all(tei_doc, xpath="//textClass/catRef[@target='#unique_annotator']/../../../fileDesc/@xml:id") %>% as_list %>% unlist() #%>% tibble::enframe(name=NULL)

# multiple_annotator <- xml_find_all(tei_doc, xpath="//textClass/catRef[@target='#multiple_annotator']/../../../fileDesc/@xml:id") %>% as_list %>% unlist()

pmc_article <- xml_find_all(tei_doc, xpath="//TEI[@subtype='pmc']//fileDesc/@xml:id") %>% as_list %>% unlist()
```


```{r, include=F}
rs <- tei_doc %>% 
  xml_find_all(xpath="//rs") 

mentions <- tibble(rs_txt = xml_text(rs), rs_attrs = xml_attrs(rs)) %>% 
  unnest_wider(rs_attrs) %>% 
  mutate(corresp = str_sub(corresp, 2, -1)) %>% 
  separate(corresp, into = c("article", "drop1", "drop2"), sep = "-", remove = F) %>% 
  select(-drop1, -drop2) %>% 
  mutate(id = if_else(is.na(id), corresp, id)) %>% 
  select(-corresp) %>% 
  mutate(article = replace_na(str_extract(id, "^(.+)(?=-software)")))


```

**1. Curated annotation counts**

```{r}
mentions %>% 
  filter(!is.na(resp)) %>% 
  mutate(curated = if_else(resp == "#curator", T, F)) %>% 
  tabyl(curated) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting() %>% 
  kable() %>% kable_styling()

```

**2: How was software mentioned?**

Note: The Venn diagram is not ideal because the overlapping between annotation fields are very sparse. Tried several ways and this is the best I can get so far. I think the issue is inherent in the data (but the data is ground truth so software is really rarely mentioned with additional information.)
But we may not use this diagram in the paper.

```{r, warning=F, message=F}
mentions %>% 
  tabyl(type) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting() %>% 
  kable() %>% kable_styling()

library(venneuler)
vd <- venneuler(c(A=5210,B=1367,C=215,D=1606,"A&B"=78,"A&C"=20,"A&B&C"=1,"A&D"=35,"A&B&D"=12,"A&C&D"=2))
vd$labels <- c("software\n5210","publisher\n1367","url\n215","version\n1606")
plot(vd)
```


```{r, include=F}
mentions <- mentions %>% 
  mutate(row = row_number()) %>% ungroup() %>% 
  pivot_wider(names_from = "type", values_from = "rs_txt") %>% 
  select(-row) %>% 
  mutate(article_set=if_else(article %in% pmc_article, "pmc", "econ")) 

software <- mentions %>% filter(!is.na(software)) %>% 
  select(-publisher, -version, -url)
publisher <- mentions %>% filter(!is.na(publisher)) %>% 
  select(-software, -version, -url)
version <- mentions %>% filter(!is.na(version)) %>% 
  select(-software, -publisher, -url)
url <- mentions %>% filter(!is.na(url)) %>% 
  select(-software, -publisher, -version)

software_mentions <- software %>% 
  left_join(version) %>% 
  left_join(publisher) %>% 
  left_join(url)


articles <- articles %>%
  as_tibble() %>%
  mutate(annotated_status = if_else(articles %in% unique_annotator, "single_annotated", "multiple_annotated")) %>% 
  mutate(article_set =if_else(articles %in% pmc_article, "pmc", "econ"))
```

```{r}
software_mentions %>% 
  pivot_longer(cols=c("software","publisher","url","version"),
               names_to = "type", values_to = "rs_txt",values_drop_na = T) %>% 
  tabyl(type,article_set) %>% 
  adorn_totals("row") %>% 
  adorn_percentages("row") %>% 
  adorn_pct_formatting() %>% 
  adorn_ns() %>% 
  kable() %>% 
  kable_styling()
  
```

**3. If the mentioned software was used**


```{r}
sm <- software_mentions %>% 
  mutate(subtype = replace_na(subtype, "not_used")) %>% 
  rename(software_was_used=subtype)

sm %>% 
  tabyl(software_was_used) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting() %>% 
  kable() %>% kable_styling()

sm %>% 
  tabyl(software_was_used, article_set) %>% 
  adorn_totals("row") %>% 
  adorn_percentages("col") %>% 
  adorn_pct_formatting() %>% 
  adorn_ns() %>% 
  kable() %>% kable_styling()

sm %>% 
  group_by(software_was_used) %>% 
  summarise(n = n_distinct(id)) %>% 
  ggplot(aes(x="", y=n, fill=software_was_used)) +
  geom_bar(stat="identity") +
  coord_polar("y", start=0) +
  theme(axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.border = element_blank(),
  panel.grid=element_blank(),
  axis.ticks = element_blank(),
  axis.text = element_blank()) +
  #geom_text(aes(label=n_article), hjust=2)
  scale_fill_manual(values=c("#E69F00", "#56B4E9")) +
  labs(title="How many software mentioned was used?")

sm %>% 
  group_by(software_was_used, article_set) %>% 
  summarise(n = n_distinct(id)) %>% 
  ggplot(aes(x=article_set, y=n, fill=software_was_used)) +
  geom_bar(stat="identity") + 
  scale_fill_manual(values=wes_palette("Darjeeling2"))
```





**4: How many articles were multiply annotated?**

```{r}
articles %>% 
  tabyl(annotated_status) %>% 
  adorn_totals("row") %>% 
  adorn_pct_formatting() %>% 
  kable() %>% kable_styling()

articles %>% 
  tabyl(annotated_status, article_set) %>% 
  adorn_totals("row") %>% 
  adorn_percentages("col") %>% 
  adorn_pct_formatting() %>%
  adorn_ns() %>% 
  kable() %>% kable_styling()

articles %>% 
  group_by(annotated_status) %>% 
  summarise(n_article = n_distinct(value)) %>% 
  ggplot(aes(x="", y=n_article, fill=annotated_status)) +
  geom_bar(stat="identity") +
  coord_polar("y", start=0) +
  theme(axis.title.x = element_blank(),
  axis.title.y = element_blank(),
  panel.border = element_blank(),
  panel.grid=element_blank(),
  axis.ticks = element_blank(),
  axis.text = element_blank()) +
  #geom_text(aes(label=n_article), hjust=2)
  scale_fill_manual(values=wes_palette("Chevalier1"))

articles %>% 
  group_by(annotated_status, article_set) %>% 
  summarise(n_article = n_distinct(value)) %>% 
  ggplot(aes(x=article_set, y=n_article, fill=annotated_status)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values=wes_palette("Moonrise2"))
```

**5: The top 10 mentioned software entities**

```{r}
software %>% 
  group_by(software) %>% 
  summarise(n_mention = n_distinct(id)) %>% 
  arrange(desc(n_mention)) %>% head(10) %>% 
  kable() %>% kable_styling()
```

**Top 10 software mentioned in PMC articles:**

```{r}
software %>% 
  filter(article_set=="pmc") %>% 
  group_by(software) %>% 
  summarise(n_mention = n_distinct(id)) %>% 
  arrange(desc(n_mention)) %>% head(10) %>% 
  kable() %>% kable_styling()
```

**Top 10 software mentioned in econ articles:**
```{r}
software %>% 
  filter(article_set=="econ") %>% 
  group_by(software) %>% 
  summarise(n_mention = n_distinct(id)) %>% 
  arrange(desc(n_mention)) %>% head(10) %>% 
  kable() %>% kable_styling()
```


**6. Distribution of mention counts across articles:**

**In all the articles:**

```{r}
software_mentions %>% 
  group_by(article) %>% 
  summarise(n_software=n_distinct(id)) %>% 
  group_by(n_software) %>% 
  summarise(n_article = n_distinct(article)) %>% 
  mutate(mention_count=case_when(
    n_software <= 10 ~ "(0, 10]",
    n_software > 10 & n_software <= 25 ~ "(10, 25]",
    n_software > 25 & n_software <= 50 ~ "(25, 50]",
    n_software > 50 & n_software <= 75 ~ "(50, 75]",
    n_software > 75  ~ "(75, 300)")) %>% 
  group_by(mention_count) %>% 
  summarise(article_count = sum(n_article)) %>% 
  adorn_totals("row") %>% 
  knitr::kable() %>% 
  kable_styling(full_width = F)

software_mentions %>% 
  group_by(article) %>% 
  summarise(n_software=n_distinct(id)) %>% 
  group_by(n_software) %>% 
  summarise(n_article = n_distinct(article)) %>% 
  ggplot(aes(x=n_software, y=n_article)) +
  geom_violin(scale="area") +
  labs(title="Distribution of mention counts in articles", x="Number of software mentions", y="Number of articles") 
```

**In different article sets:**

```{r}
software_mentions %>% 
  group_by(article, article_set) %>% 
  summarise(n_software=n_distinct(id)) %>% 
  group_by(n_software, article_set) %>% 
  summarise(n_article = n_distinct(article)) %>% 
  mutate(mention_count=case_when(n_software <= 10 ~ "(0, 10]",
    n_software > 10 & n_software <= 25 ~ "(10, 25]",
    n_software > 25 & n_software <= 50 ~ "(25, 50]",
    n_software > 50 & n_software <= 75 ~ "(50, 75]",
    n_software > 75  ~ "(75, 300)")) %>% 
  group_by(mention_count, article_set) %>% 
  summarise(article_count = sum(n_article)) %>% 
  pivot_wider(names_from = article_set, values_from = article_count) %>% 
  adorn_totals("row") %>% 
  knitr::kable() %>% 
  kable_styling(full_width = F)

software_mentions %>% 
  group_by(article, article_set) %>% 
  summarise(n_software=n_distinct(id)) %>% 
  group_by(n_software, article_set) %>% 
  summarise(n_article = n_distinct(article)) %>% 
  ggplot(aes(x=article_set, y=n_article, fill=article_set)) +
  geom_violin(scale="area") +
  labs(title="Distribution of mention counts in articles across different article sets", x="Number of software mentions", y="Number of articles") +
  scale_fill_manual(values=wes_palette("Zissou1"))
```


```{r, include=F}
## data input 
# total=5210
# with_publisher=78
# with_url=20
# with_ver=35
# w_pub_url=1
# w_pub_ver=12
# with_all=0
# w_ver_url=2
# w_null=5092

# Analytical axes:
# displines, software_was_used, software mentioned with ___, curation level
```